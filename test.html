<!DOCTYPE html>
<meta charset="utf-8">
<title>Test Suite</title>
<link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.18.0.css">
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <script src="https://code.jquery.com/qunit/qunit-2.18.0.js"></script>
  <script type="text/javascript" src="js/parser.js"></script>
  <script type="text/javascript" src="js/st.js"></script>

  <script>

    const { test } = QUnit;

    QUnit.module( "Parsing", hooks => {
        let parser;

        let HEADING = [
            [ "EXT. BRICK'S POOL - DAY",
              { INT: false, EXT: true, location: ["BRICK'S POOL"], others: ["DAY"], line: "EXT. BRICK'S POOL – DAY" } ],
            [ ".SNIPER SCOPE POV",
              { INT: false, EXT: false, location: ["SNIPER SCOPE POV"], others: [], line: "SNIPER SCOPE POV" } ],
            [ "ext. brick's pool - day",
                { INT: false, EXT: true, location: ["brick's pool"], others: ["day"], line: "EXT. brick's pool – day" } ],
            [ "INT. HOUSE - DAY    #1#    ",
                { INT: true, EXT: false, location: ["HOUSE"], others: ["DAY"], line: "INT. HOUSE – DAY #1#", sceneNumber: "1" } ],
            [ "Ext. HOUSE - DAY #1A#",
                { INT: false, EXT: true, location: ["HOUSE"], others: ["DAY"], line: "EXT. HOUSE – DAY #1A#", sceneNumber: "1A" } ],
            [ "EST. HOUSE - DAY #1a#",
                { INT: false, EXT: true, location: ["HOUSE"], others: ["DAY"], line: "EXT. HOUSE – DAY #1a#", sceneNumber: "1a" } ],
            [ "INT./EXT HOUSE - DAY #A1#",
                { INT: true, EXT: true, location: ["HOUSE"], others: ["DAY"], line: "INT/EXT. HOUSE – DAY #A1#", sceneNumber: "A1" } ],
            [ "INT/EXT HOUSE - DAY #I-1-A#",
                { INT: true, EXT: true, location: ["HOUSE"], others: ["DAY"], line: "INT/EXT. HOUSE – DAY #I-1-A#", sceneNumber: "I-1-A" } ],
            [ "I/E HOUSE  -   DAY #1.#",
                { INT: true, EXT: true, location: ["HOUSE"], others: ["DAY"], line: "INT/EXT. HOUSE – DAY #1.#", sceneNumber: "1." } ],
            [ "INT. HOUSE - DAY - FLASHBACK (1944) #110A#    ",
                { INT: true, EXT: false, location: ["HOUSE"], others: ["DAY", "FLASHBACK (1944)"], line: "INT. HOUSE – DAY – FLASHBACK (1944) #110A#", sceneNumber: "110A" } ],
            [ "EXT/INT  Espace/forêt/Appartement de HC - Nuit",
                { INT: true, EXT: true, location: ["Espace", "forêt", "Appartement de HC"], others: ["Nuit"], line: "INT/EXT. Espace/forêt/Appartement de HC – Nuit" } ],
            [ "EXT. STUDIO DE TOURNAGE - JOUR",
                { INT: false, EXT: true, location: ["STUDIO DE TOURNAGE"], others: ["JOUR"], line: "EXT. STUDIO DE TOURNAGE – JOUR"} ],
            [ ".Générique de fin",
                { INT: false, EXT: false, location: ["Générique de fin"], others: [], line: "Générique de fin"} ]
        ];

        let DIALOG = [
            [ "STEEL\nThe man's a myth!",
                { character: "STEEL", 'character-cue': "STEEL", block: "dialog", "parenthesis": undefined, dialog: [
                    "The man's a myth!" ] } ],
            [ "MOM (O. S.)\nLuke! Come down for supper!",
                { character: "MOM", 'character-cue': "MOM (O. S.)", block: "dialog", "parenthesis": 'O. S.', dialog: [
                    "Luke! Come down for supper!" ] } ],
            [ "HANS (on the radio)\nWhat was it you said?",
                { character: "HANS", 'character-cue': "HANS (on the radio)", block: "dialog", "parenthesis": 'on the radio', dialog: [
                    "What was it you said?" ] } ],
            [ "@McCLANE\nYippie ki-yay! I got my lower-case C back!",
                { character: "McCLANE", 'character-cue': "McCLANE", block: "dialog", "parenthesis": undefined, dialog: [
                    "Yippie ki-yay! I got my lower-case C back!" ] } ],
            [ "SANBORN\nA good 'ole boy. You know, loves the Army, blood runs green. Country boy. Seems solid.",
                { character: "SANBORN", 'character-cue': "SANBORN", block: "dialog", "parenthesis": undefined, dialog: [
                    "A good 'ole boy. You know, loves the Army, blood runs green. Country boy. Seems solid." ] } ],
            [ "\tDAN\nThen let's retire them. \n_Permanently_.",
                { character: "DAN", 'character-cue': "DAN", block: "dialog", "parenthesis": undefined, dialog: [
                    "Then let's retire them.", "_Permanently_." ] } ],
            [ "STEEL\n(starting the engine)\nSo much for retirement!",
                { character: "STEEL", 'character-cue': "STEEL", block: "dialog", "parenthesis": undefined, dialog: [
                    "(starting the engine)", "So much for retirement!" ] } ],
            [ "STEEL ^\nScrew retirement.",
                { character: "STEEL", 'character-cue': "STEEL", block: "dual-dialog", "parenthesis": undefined, dialog: [
                    "Screw retirement." ] } ],
            [ "WILLY WONKA\n~Willy Wonka! The amazing chocolatier!",
                { character: "WILLY WONKA", 'character-cue': "WILLY WONKA", block: "dialog", "parenthesis": undefined, dialog: [
                    "~Willy Wonka! The amazing chocolatier!" ] } ],
            [ "     JYCR   (H.C.)\n   (énervé)\n  HC !\n",
                { character: "JYCR", 'character-cue': "JYCR (H.C.)", block: "dialog", "parenthesis": 'H.C.', dialog: [
                    "(énervé)", "HC !" ] } ],
            [ "HC\n(chuchote)\n…Longue vie et prospérité…[[SRC:humour:Spock]]",
                { character: "HC", 'character-cue': "HC", block: "dialog", "parenthesis": undefined, dialog: [
                    "(chuchote)", "…Longue vie et prospérité…[[SRC:humour:Spock]]" ] } ],
            [ "JYCR\nNon, parce que je ne ferais pas le signe stupide avec la main.\n[[SRC:humour:Spock]]\n",
                { character: "JYCR", 'character-cue': "JYCR", block: "dialog", "parenthesis": undefined, dialog: [
                    "Non, parce que je ne ferais pas le signe stupide avec la main.", "[[SRC:humour:Spock]]" ] } ],
            [ "JYCR (CONT’D)\nsauf les oiseaux.",
                { character: "JYCR", 'character-cue': "JYCR (CONT’D)", block: "dialog", "parenthesis": 'CONT’D', dialog: [
                    "sauf les oiseaux." ] } ],
            [ "R2D2\nbibop",
                { character: "R2D2", 'character-cue': "R2D2", block: "dialog", "parenthesis": undefined, dialog: [
                    "bibop" ] } ],
            // [ "",
            //     { character: "", 'character-cue': "", block: "dialog", dialog: [
            //         "" ] } ],
            //
        ];

        let TRANSITION = [
            [ "CUT TO:", "CUT TO:" ],
            [ "     CUT TO:", "CUT TO:" ],
            [ "> Burn to White.", "Burn to White." ],
        ];


        hooks.beforeEach( () => {
            parser = new FountainParser(undefined, undefined);
        });

// =============== TITLE PAGE =================================================

        test( "isTitlePage", (assert) => {
            var titlePage = "Title:\n    _**BRICK & STEEL**_\n    _**FULL RETIRED**_\nCredit: Written by\n"
                            + "Author: Stu Maschwitz\nSource: Story by KTM\nDraft date: 1/20/2012\n"
                            + "Contact:\n    Next Level Productions\n    1588 Mission Dr.\n    Solvang, CA 93463\n";
            assert.true(parser.isTitlePage(titlePage), 'It’s a title page');
            titlePage = "Draft date: 6/23/2012";
            assert.true(parser.isTitlePage(titlePage), 'It’s a title page');
            titlePage = "Title: Présentation de la chaîne\nCredit: Written by\nAuthor: JCG\nSource: Story by KTM\nDraft date: 2022-02-22";
            assert.true(parser.isTitlePage(titlePage), 'It’s a title page');
            assert.true(parser.isTitlePage("    " + titlePage), 'It’s a title page');
            assert.true(parser.isTitlePage("Title  : Présentation"), 'It’s a title page');
            assert.false(parser.isTitlePage("Title Présentation"), 'It’s not a title page');
        });

        test( "parseTitlePage", (assert) => {
            var titlePage = "Title:\n    _**BRICK & STEEL**_\n    _**FULL RETIRED**_\nCredit: Written by\n"
                            + "Author: Stu Maschwitz\nSource: Story by KTM\nDraft date: 1/20/2012\n"
                            + "Contact:\n    Next Level Productions\n    1588 Mission Dr.\n    Solvang, CA 93463\n";
            var o = parser.parseTitlePage(titlePage);
            assert.propEqual(o, {
                title: [ "_**BRICK & STEEL**_", "_**FULL RETIRED**_"],
                credit: ["Written by"],
                author: ["Stu Maschwitz"],
                source: ["Story by KTM"],
                draft_date: ["1/20/2012"],
                contact: [ "Next Level Productions", "1588 Mission Dr.", "Solvang, CA 93463"]
            });

            titlePage = "Draft date: 6/23/2012";
            assert.propEqual(parser.parseTitlePage(titlePage), { draft_date: ["6/23/2012"] });

            titlePage = "Title: Présentation de la chaîne\nCredit: Written by\nAuthor: JCG\nSource: Story by KTM\nDraft date: 2022-02-22";
            assert.propEqual(parser.parseTitlePage(titlePage), {
                title: [ "Présentation de la chaîne"],
                credit: ["Written by"],
                source: ["Story by KTM"],
                author: ["JCG"],
                draft_date: ["2022-02-22"]
            });

            assert.propEqual(parser.parseTitlePage("    " + titlePage), {
                title: [ "Présentation de la chaîne"],
                credit: ["Written by"],
                source: ["Story by KTM"],
                author: ["JCG"],
                draft_date: ["2022-02-22"]
            });

        });

// =============== HEADING ====================================================
        test.each( "isHeading", HEADING, ( assert, [data] ) => {
            assert.true(parser.isHeading(data), `${data} is Heading`);
        });

        test.each( "isHeading (escaped)", HEADING, ( assert, [data] ) => {
            assert.false(parser.isHeading('!' + data), `!${data} is not Heading`);
        });

        test.each( "! isHeading (DIALOG)", DIALOG, ( assert, [data] ) => {
            assert.false(parser.isHeading(data), `${data} is not Heading`);
        });

        test.each( "parseHeading", HEADING, ( assert, [data, expected] ) => {
            var actual = parser.parseHeading(data);
            assert.equal(actual.line, expected.line, `${actual.line} is correctly formated`);
            assert.equal(actual.INT, expected.INT, `INT ${actual.INT} is correct`);
            assert.equal(actual.EXT, expected.EXT, `EXT ${actual.EXT} is correct`);
            assert.deepEqual(actual.location, expected.location, `location of ${actual.line} is correct`);
            assert.deepEqual(actual.others, expected.others, `others of ${actual.line} is correct`);
            assert.equal(actual.sceneNumber, expected.sceneNumber, `${actual.sceneNumber} is sceneNumber`);
        });

// =============== DIALOG ====================================================
        test.each( "isDialog", DIALOG, ( assert, [data] ) => {
            assert.true(parser.isDialog(data), `${data} is Heading`);
        });

        test.each( "! isDialog (HEADING)", HEADING, ( assert, [data] ) => {
            assert.false(parser.isDialog(data), `${data} is Dialog`);
        });

        test( "! isDialog", (assert) => {
            assert.false(parser.isDialog("McCLANE\nYippie ki-yay!"), '"McCLANE\nYippie ki-yay!" is not Dialog');
        });

        test.each( "parseDialog", DIALOG, ( assert, [data, expected] ) => {
            var actual = parser.parseDialog(data);
            assert.equal(actual.character, expected.character, `${actual.character} is correctly formated`);
            assert.equal(actual['character-cue'], expected['character-cue'], `${actual['character-cue']} is correct`);
            assert.deepEqual(actual.dialog, expected.dialog, `${actual.dialog} is correct`);
            assert.equal(actual.block, expected.block, `${actual.block} is correct`);
            assert.propEqual(actual, expected);
        });

// =============== TRANSITION =================================================
        test.each( "isTransition", TRANSITION, ( assert, [data] ) => {
            assert.true(parser.isTransition(data), `${data} is Transition`);
        });

        test( "! isTransition", ( assert ) => {
            assert.false(parser.isTransition("CUT TO: "), '"CUT TO: " is not Transition');
            assert.false(parser.isTransition(".CUT TO:"), '".CUT TO:" is not Transition');
        });

        test.each( "parseTransition", TRANSITION, ( assert, [data, expected] ) => {
            var actual = parser.parseTransition(data);
            assert.equal(actual, expected, `${data} is correctly formated`);
        });

    });

    QUnit.module( "SousTitre", hooks => {
        let ulElement, st;

        hooks.beforeEach( () => {
            ulElement = document.createElement("ul");
            st = new SousTitre(ulElement);
        });

        test( "reset", (assert) => {
            ulElement.innerHTML = "<li>TOTO</li>";
            st.reset();
            assert.equal(ulElement.innerHTML, "");
        });

        test("addAction", (assert) => {
            st.addAction(["basic action."]);
            assert.equal(ulElement.innerHTML, "");
            st.addAction(["Action avec un `bruit`"]);
            assert.equal(ulElement.innerHTML, '<li class="bruit">bruit</li>\n');
            st.addAction(["Action `avec` un bruit.", "`soustitre` qui désigne un son."]);
            assert.equal(ulElement.innerHTML, '<li class="bruit">bruit</li>\n<li class="bruit">avec</li>\n<li class="bruit">soustitre</li>\n');
        });

        test("addDialog", (assert) => {
            st.addDialog({character: 'FOO', parenthesis: undefined, dialog: [
                '(bépo)', 'salut', '(zozo)'
            ]});
            assert.equal(ulElement.innerHTML, '<li>- salut</li>\n');

        });

        test("addDialog longue ligne", (assert) => {
            st.addDialog({character: '', parenthesis: undefined, dialog: [
                'Une ligne vraiment très très très longue'
            ]});
            assert.equal(ulElement.innerHTML, '<li>Une ligne vraiment très très très</li>\n<li>longue</li>\n');

        });

        test("addDialog Hors champ", (assert) => {
            st.addDialog({character: '', parenthesis: 'H.C.', dialog: [
                'Une ligne pas très longue'
            ]});
            assert.equal(ulElement.innerHTML, '<li class="horsChamp">Une ligne pas très longue</li>\n');
        });

        test("addDialog off", (assert) => {
            st.addDialog({character: '', parenthesis: 'off', dialog: [
                'Une ligne pas très longue'
            ]});
            assert.equal(ulElement.innerHTML, '<li class="off">Une ligne pas très longue</li>\n');
        });

        test("addDialog music", (assert) => {
            st.addDialog({character: '', parenthesis: undefined, dialog: [
                '~Une ligne chantée'
            ]});
            assert.equal(ulElement.innerHTML, '<li class="music">Une ligne chantée</li>\n');

        });

        test("addDialog étrangère", (assert) => {
            st.addDialog({character: '', parenthesis: undefined, dialog: [
                'Ne pas confondre ``Homo`` et Homo.'
            ]});
            assert.equal(ulElement.innerHTML, '<li>Ne pas confondre <span class="etrangere">Homo</span> et Homo.</li>\n');

            ulElement.innerHTML = '';
            st.addDialog({character: '', parenthesis: undefined, dialog: [
                '``Homo`` et ``Homo georgicus``.'
            ]});
            assert.equal(ulElement.innerHTML, '<li><span class="etrangere">Homo</span> et <span class="etrangere">Homo georgicus</span>.</li>\n');
        });
    });

  </script>
</body>
